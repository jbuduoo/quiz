# 「我的最愛」（收藏）功能邏輯說明

## 一、資料結構定義

### 1. UserAnswer 介面
```typescript
// src/types/index.ts
export interface UserAnswer {
  questionId: string;
  isCorrect: boolean;            // 是否答對
  isAnswered: boolean;           // 是否已作答
  selectedAnswer?: 'A' | 'B' | 'C' | 'D';
  isFavorite: boolean;           // ⭐ 是否收藏（我的最愛）
  isInWrongBook: boolean;        // 是否在錯題本
  isUncertain: boolean;          // 是否不確定
  wrongCount: number;            // 錯誤次數
  lastAnsweredAt?: Date;
  lastWrongAt?: Date;
}
```

### 2. WrongBookFilter 介面
```typescript
// src/types/index.ts
export interface WrongBookFilter {
  subject?: string;
  onlyWrong?: boolean;
  onlyFavorite?: boolean;         // ⭐ 僅複習收藏題
}
```

---

## 二、核心業務邏輯（QuestionService.ts）

### 1. toggleFavorite() - 切換收藏狀態
**位置：** `src/services/QuestionService.ts:272-299`

**功能：**
- 切換題目的收藏狀態（true ↔ false）
- **同步更新錯題本狀態**：
  - 收藏（true）→ 自動加入錯題本（`isInWrongBook = true`）
  - 取消收藏（false）→ 自動從錯題本移除（`isInWrongBook = false`）

**邏輯流程：**
```typescript
async toggleFavorite(questionId: string): Promise<boolean> {
  1. 取得現有的答題記錄
  2. 切換收藏狀態：newFavoriteStatus = !existingAnswer.isFavorite
  3. 同步更新錯題本：isInWrongBook = newFavoriteStatus
  4. 返回新的收藏狀態
}
```

**關鍵規則：**
- ✅ 收藏與錯題本完全同步
- ✅ 收藏 = 加入錯題本
- ✅ 取消收藏 = 移除錯題本

---

### 2. updateUserAnswer() - 更新答題記錄時的收藏邏輯
**位置：** `src/services/QuestionService.ts:222-270`

#### 2.1 答錯時的處理
```typescript
// 如果答錯，更新錯誤次數
if (answer.isCorrect === false && existingAnswer.isAnswered) {
  updatedAnswer.wrongCount = existingAnswer.wrongCount + 1;
  updatedAnswer.lastWrongAt = new Date();
}
```

**規則：**
- 答錯時，更新錯誤次數和最後答錯時間

#### 2.2 答對時的處理
```typescript
// 如果答對，更新答題時間
if (answer.isCorrect === true) {
  updatedAnswer.lastAnsweredAt = new Date();
}
```

**規則：**
- 答對時，更新最後答題時間

#### 2.3 收藏狀態同步錯題本（核心邏輯）
```typescript
// 根據收藏狀態同步錯題本狀態（不管答對還是答錯）
// 已收藏 → 加入錯題本
// 未收藏 → 從錯題本移除
updatedAnswer.isInWrongBook = updatedAnswer.isFavorite;
```

**規則：**
- ⭐ **已收藏 → 加入錯題本**（不管答對還是答錯）
- ⭐ **未收藏 → 從錯題本移除**（不管答對還是答錯）
- 收藏狀態決定錯題本狀態，與答題結果無關

---

### 3. getWrongBookQuestions() - 取得錯題本題目
**位置：** `src/services/QuestionService.ts:405-440`

**核心邏輯：**
```typescript
// 錯題本只顯示收藏的題目
if (!answer.isFavorite) return false;

// 如果指定 onlyWrong，則只顯示答錯的收藏題
if (filter?.onlyWrong && answer.isCorrect) return false;
```

**規則：**
- ✅ **錯題本只顯示收藏的題目**（`isFavorite === true`）
- ✅ 可以透過 `onlyWrong` 篩選器，只顯示答錯的收藏題
- ✅ 可以透過 `subject` 篩選器，依科目篩選

---

### 4. getWrongBookStats() - 取得錯題本統計
**位置：** `src/services/QuestionService.ts:445-477`

**統計邏輯：**
```typescript
allQuestions.forEach(q => {
  const answer = userAnswers[q.id];
  if (answer && answer.isFavorite) {  // ⭐ 只統計收藏的題目
    favoriteCount++;
    // 統計收藏中答錯的題數
    if (answer.isAnswered && !answer.isCorrect) {
      wrongCount++;
    }
  }
});

// 總數就是收藏的題數
const total = favoriteCount;
```

**返回資料：**
- `total`: 收藏的題目總數
- `wrongCount`: 收藏中答錯的題數
- `favoriteCount`: 收藏的題目總數（與 total 相同）

---

### 5. removeFromWrongBook() - 從錯題本移除
**位置：** `src/services/QuestionService.ts:331-343`

**邏輯：**
```typescript
async removeFromWrongBook(questionId: string): Promise<void> {
  await this.updateUserAnswer(questionId, {
    isInWrongBook: false,
    isFavorite: false,      // ⭐ 同時取消收藏
    isUncertain: false,
  });
}
```

**規則：**
- 從錯題本移除時，**同時取消收藏**
- 清除所有相關記錄（錯題、不確定等）

---

### 6. clearSeriesAnswers() - 清空期數答題記錄
**位置：** `src/services/QuestionService.ts:819-861`

**邏輯：**
```typescript
// 保留收藏狀態，但清空所有答題相關的記錄
userAnswers[question.id] = {
  questionId: question.id,
  isCorrect: false,
  isAnswered: false,
  selectedAnswer: undefined,
  isFavorite: existingAnswer.isFavorite || false,  // ⭐ 保留收藏狀態
  isInWrongBook: false,
  isUncertain: false,
  wrongCount: 0,
};
```

**規則：**
- 重新測驗時，**保留收藏狀態**
- 清空答題記錄、錯誤次數等

---

## 三、UI 層邏輯

### 1. QuizScreen.tsx - 答題頁面

#### 1.1 狀態管理
```typescript
const [isFavorite, setIsFavorite] = useState(false);
```

#### 1.2 載入收藏狀態
```typescript
// src/screens/QuizScreen.tsx:84, 90
setIsFavorite(answer?.isFavorite || false);
```

#### 1.3 答題後的處理
```typescript
// src/screens/QuizScreen.tsx:119
// 答題後，收藏狀態會自動同步錯題本狀態（在 updateUserAnswer 中處理）
```

**規則：**
- 答題後，`updateUserAnswer()` 會自動根據收藏狀態同步錯題本狀態
- 不需要額外處理，邏輯統一在 Service 層

#### 1.4 切換收藏功能
```typescript
// src/screens/QuizScreen.tsx:157-167
const handleToggleFavorite = async () => {
  const currentQuestion = questions[currentIndex];
  if (!currentQuestion) return;

  const newFavoriteStatus = await QuestionService.toggleFavorite(currentQuestion.id);
  setIsFavorite(newFavoriteStatus);
  
  // 重新載入用戶答案以更新狀態
  await loadUserAnswer();
};
```

#### 1.5 UI 顯示
```typescript
// src/screens/QuizScreen.tsx:463-477
{!isReviewMode && (
  <TouchableOpacity
    style={[styles.footerButton, styles.footerButtonYellow]}
    onPress={handleToggleFavorite}
  >
    <Text style={styles.footerButtonText}>
      <Text style={styles.footerButtonIconText}>
        {isFavorite ? '❤️' : '🤍'}
      </Text>
      {isFavorite && ' 我的最愛'}
    </Text>
  </TouchableOpacity>
)}
```

**顯示規則：**
- ❤️ = 已收藏（我的最愛）
- 🤍 = 未收藏

---

### 2. ReviewQuizScreen.tsx - 複習錯題頁面

#### 2.1 狀態管理
```typescript
const [isFavorite, setIsFavorite] = useState(false);
```

#### 2.2 載入收藏狀態
```typescript
// src/screens/ReviewQuizScreen.tsx:81
setIsFavorite(answer?.isFavorite || false);
```

#### 2.3 答題後的處理
```typescript
// src/screens/ReviewQuizScreen.tsx:113
// 答題後，收藏狀態會自動同步錯題本狀態（在 updateUserAnswer 中處理）
```

**規則：**
- 答題後，`updateUserAnswer()` 會自動根據收藏狀態同步錯題本狀態
- 不需要額外處理，邏輯統一在 Service 層

#### 2.4 切換收藏功能（特殊邏輯）
```typescript
// src/screens/ReviewQuizScreen.tsx:218-240
const handleToggleFavorite = async () => {
  const currentQuestion = questions[currentIndex];
  if (!currentQuestion) return;

  const newFavoriteStatus = await QuestionService.toggleFavorite(currentQuestion.id);
  setIsFavorite(newFavoriteStatus);
  
  // ⭐ 如果取消收藏，從錯題本移除後，自動跳到下一題
  if (!newFavoriteStatus) {
    await loadUserAnswer();
    
    // 如果還有其他題目，繼續下一題；否則返回錯題本頁
    if (questions.length > 1) {
      handleNext();
    } else {
      navigation.goBack();
    }
  } else {
    await loadUserAnswer();
  }
};
```

**特殊規則：**
- 取消收藏時，自動跳到下一題（或返回錯題本頁）
- 因為題目已從錯題本移除，不需要繼續顯示

#### 2.5 UI 顯示
```typescript
// src/screens/ReviewQuizScreen.tsx:385-388
<TouchableOpacity
  style={[styles.footerButton, styles.footerButtonYellow]}
  onPress={handleToggleFavorite}
>
  <Text style={styles.footerButtonText}>
    {isFavorite ? '❤️ 我的最愛' : '🤍'}
  </Text>
</TouchableOpacity>
```

---

### 3. WrongBookScreen.tsx - 錯題本頁面

#### 3.1 顯示收藏圖標
```typescript
// src/screens/WrongBookScreen.tsx:142-144
{/* 錯題本只顯示收藏的題目，所以所有題目都顯示收藏圖標 */}
{isFavorite && (
  <Text style={styles.favoriteIcon}>❤️</Text>
)}
```

**規則：**
- 錯題本只顯示收藏的題目，所以所有題目都會顯示 ❤️ 圖標

#### 3.2 篩選功能
```typescript
// src/screens/WrongBookScreen.tsx:88-94
const handleToggleOnlyFavorite = (value: boolean) => {
  const newFilter: WrongBookFilter = {
    ...filter,
    onlyFavorite: value,
  };
  setFilter(newFilter);
};
```

**注意：**
- 由於錯題本已經只顯示收藏的題目，`onlyFavorite` 篩選器實際上沒有作用
- 但保留此功能以維持向後相容性

#### 3.3 統計顯示
```typescript
// src/screens/WrongBookScreen.tsx:183
共 {stats.total} 題 | 錯題 {stats.wrongCount} 題 | 收藏 {stats.favoriteCount} 題
```

**說明：**
- `stats.total` = 收藏的題目總數
- `stats.wrongCount` = 收藏中答錯的題數
- `stats.favoriteCount` = 收藏的題目總數（與 total 相同）

---

## 四、核心業務規則總結

### 規則 1：收藏與錯題本完全同步
- ✅ **收藏 = 加入錯題本**：點擊愛心收藏時，自動加入錯題本
- ✅ **取消收藏 = 移除錯題本**：取消收藏時，自動從錯題本移除
- ✅ **錯題本只顯示收藏的題目**：錯題本頁面只會顯示 `isFavorite === true` 的題目

### 規則 2：答題時的處理
- ✅ **已收藏**：不管答對還是答錯，都加入錯題本
- ✅ **未收藏**：不管答對還是答錯，都從錯題本移除
- ✅ **答錯**：更新錯誤次數和最後答錯時間
- ✅ **答對**：更新最後答題時間
- ⭐ **收藏狀態決定錯題本狀態，與答題結果無關**

### 規則 3：重新測驗時的處理
- ✅ **保留收藏狀態**：重新測驗時，收藏狀態不會被清除
- ✅ **清空答題記錄**：重新測驗時，清空答題記錄、錯誤次數等

### 規則 4：從錯題本移除
- ✅ **同時取消收藏**：從錯題本移除時，同時取消收藏狀態
- ✅ **清除相關記錄**：清除錯題、不確定等所有相關記錄

---

## 五、資料流程圖

```
用戶點擊愛心
    ↓
toggleFavorite()
    ↓
isFavorite = true/false
    ↓
同步更新 isInWrongBook = isFavorite
    ↓
更新 AsyncStorage
    ↓
UI 更新顯示狀態
    ↓
錯題本列表更新（只顯示收藏的題目）
```

---

## 六、相關檔案清單

### 核心邏輯檔案
1. `src/services/QuestionService.ts` - 核心業務邏輯
   - `toggleFavorite()` - 切換收藏狀態
   - `updateUserAnswer()` - 更新答題記錄時的收藏邏輯
   - `getWrongBookQuestions()` - 取得錯題本題目（只顯示收藏）
   - `getWrongBookStats()` - 取得錯題本統計（只統計收藏）
   - `removeFromWrongBook()` - 從錯題本移除（同時取消收藏）

### UI 檔案
2. `src/screens/QuizScreen.tsx` - 答題頁面
   - `handleToggleFavorite()` - 切換收藏功能
   - `isFavorite` 狀態管理
   - 愛心按鈕 UI

3. `src/screens/ReviewQuizScreen.tsx` - 複習錯題頁面
   - `handleToggleFavorite()` - 切換收藏功能（含自動跳轉邏輯）
   - `isFavorite` 狀態管理
   - 愛心按鈕 UI

4. `src/screens/WrongBookScreen.tsx` - 錯題本頁面
   - 顯示收藏圖標
   - 統計顯示

### 型別定義檔案
5. `src/types/index.ts` - 型別定義
   - `UserAnswer.isFavorite` - 收藏狀態欄位
   - `WrongBookFilter.onlyFavorite` - 收藏篩選器

---

## 七、測試要點

### 測試場景 1：收藏功能
- [ ] 點擊愛心收藏題目 → 題目加入錯題本
- [ ] 再次點擊愛心取消收藏 → 題目從錯題本移除
- [ ] 收藏狀態正確顯示（❤️ / 🤍）

### 測試場景 2：答題時的收藏邏輯
- [ ] 已收藏 + 答錯 → 更新錯誤次數，加入錯題本
- [ ] 已收藏 + 答對 → 更新答題時間，保留在錯題本中
- [ ] 未收藏 + 答錯 → 更新錯誤次數，不加入錯題本（自動移除）
- [ ] 未收藏 + 答對 → 更新答題時間，自動從錯題本移除
- [ ] 收藏狀態決定錯題本狀態，與答題結果無關

### 測試場景 3：錯題本顯示
- [ ] 錯題本只顯示收藏的題目
- [ ] 取消收藏後，題目從錯題本消失
- [ ] 統計數字正確（總數 = 收藏數）

### 測試場景 4：複習錯題頁面
- [ ] 取消收藏時自動跳到下一題
- [ ] 最後一題取消收藏時返回錯題本頁

---

## 八、注意事項

1. ⚠️ **收藏與錯題本完全綁定**：無法單獨收藏而不加入錯題本，也無法單獨加入錯題本而不收藏
2. ⚠️ **錯題本只顯示收藏的題目**：未收藏的題目即使答錯，也不會出現在錯題本中
3. ⚠️ **重新測驗保留收藏狀態**：重新測驗時，收藏狀態不會被清除
4. ⚠️ **從錯題本移除會取消收藏**：使用 `removeFromWrongBook()` 時，會同時取消收藏

