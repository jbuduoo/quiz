# 資料儲存位置說明

## 資料流程

### 1. **來源資料（Excel 檔案）**
📁 **位置**：`data/*.xlsx`
- 這是原始的 Excel 題庫檔案
- 支援多個檔案，例如：
  - `IPAS_01初級_L11 人工智慧基礎概論_11409.xlsx`
  - `IPAS_02中級_L23機器學習技術與應用_11411.xlsx`
- 檔案名稱格式：`{testName}_{subject}_{series_no}.xlsx`
- 從檔案名稱自動解析 `testName`、`subject`、`series_no`

### 2. **轉換後的 JSON 檔案**

#### 2.1 **索引檔案（Index File）**
📁 **位置**：`assets/data/questions.json`
- 由轉換腳本自動生成
- 包含所有題目的總覽和導航資訊
- 格式包含：
  ```json
  {
    "metadata": {
      "version": "2.0.0",
      "lastUpdated": "2025-12-12T11:28:01.697Z",
      "totalQuestions": 374
    },
    "testNames": [
      {
        "id": "test-IPAS_01",
        "name": "IPAS_01",
        "totalQuestions": 185,
        "completedQuestions": 0,
        "completionPercentage": 0
      }
    ],
    "subjects": [...],
    "series": [...],
    "questionFiles": [
      {
        "testName": "IPAS_01",
        "subject": "L11",
        "series_no": "11409",
        "file": "questions/IPAS_01_L11_11409.json",
        "count": 50
      }
    ]
  }
  ```

#### 2.2 **題目檔案（Question Files）**
📁 **位置**：`assets/data/questions/*.json`
- 每個檔案對應一個測驗的特定科目和期數
- 檔案命名格式：`{testName}_{subject}_{series_no}.json`
- 例如：`IPAS_01_L11_11409.json`
- 格式包含：
  ```json
  {
    "metadata": {
      "testName": "IPAS_01",
      "subject": "L11",
      "series_no": "11409",
      "sourceFile": "IPAS_01初級_L11 人工智慧基礎概論_11409.xlsx",
      "count": 50
    },
    "questions": [
      {
        "id": "IPAS_01_L11_11409_1",
        "content": "...",
        "options": {
          "A": "...",
          "B": "...",
          "C": "...",
          "D": "..."
        },
        "correctAnswer": "D",
        "explanation": "...",
        "chapter": "..."  // 可選
      }
    ]
  }
  ```

**重要變更：**
- ⚠️ 題目物件中**不再包含** `testName`、`subject`、`series_no` 欄位
- ✅ 這些資訊存在於檔案的 `metadata` 中
- ✅ 載入時會自動從 `metadata` 補充到題目物件
- ✅ 題目 `id` 格式：`{testName}_{subject}_{series_no}_{題號}`（例如：`IPAS_01_L11_11409_1`）

### 3. **執行時儲存（AsyncStorage）**

App 執行時，資料會儲存在裝置的本地儲存空間：

#### **React Native（iOS/Android）**
- 使用 `@react-native-async-storage/async-storage`
- 儲存位置：
  - **iOS**：`NSUserDefaults`（應用程式沙盒）
  - **Android**：`SharedPreferences`（應用程式私有資料夾）

#### **Web 平台**
- 使用瀏覽器的 `LocalStorage`
- 儲存位置：瀏覽器的本地儲存空間

### 4. **儲存的資料鍵值**

系統使用以下鍵值儲存資料：

| 鍵值 | 說明 | 內容 |
|------|------|------|
| `@quiz:userAnswers` | 用戶答題記錄 | 答題狀態、錯題、收藏等（以題目 `id` 為 key） |
| `@quiz:chapters` | 章節列表 | 章節資訊與進度 |
| `@quiz:testNames` | 測驗名稱列表 | 測驗名稱資訊與進度 |
| `@quiz:subjects` | 科目列表 | 科目資訊與進度 |
| `@quiz:series` | 期數列表 | 期數資訊與進度 |
| `@quiz:quizProgress` | 測驗進度 | 各測驗的當前進度 |
| `@quiz:dataVersion` | 資料版本 | 版本號（用於判斷是否需要更新） |

**注意：**
- ⚠️ 題目資料**不再儲存**在 AsyncStorage 中
- ✅ 題目資料按需從 JSON 檔案載入（使用快取機制）
- ✅ 用戶答題記錄使用題目 `id` 作為 key（格式：`IPAS_01_L11_11409_1`）

## 資料載入流程

```
1. App 啟動
   ↓
2. 載入索引檔案 (assets/data/questions.json)
   ├─ 取得測驗列表、科目列表、期數列表
   ├─ 取得題目檔案路徑映射
   └─ 儲存到 AsyncStorage (@quiz:testNames, @quiz:subjects, @quiz:series)
   ↓
3. 檢查資料版本 (@quiz:dataVersion)
   ↓
4. 如果版本不同：
   ├─ 清除舊的用戶答題記錄 (@quiz:userAnswers)
   ├─ 清除舊的測驗進度 (@quiz:quizProgress)
   └─ 更新版本號為 4.0.0
   ↓
5. 按需載入題目檔案
   ├─ 從 questionFiles 取得檔案路徑
   ├─ 載入對應的 JSON 檔案（例如：IPAS_01_L11_11409.json）
   ├─ 從 metadata 補充 testName、subject、series_no 到題目物件
   └─ 使用快取機制避免重複載入
   ↓
6. 動態生成章節列表（如果有 chapter 欄位）
   └─ 儲存到 AsyncStorage (@quiz:chapters)
```

## 資料更新方式

### 更新題目資料

1. **更新 Excel 檔案**
   - 將新的 Excel 檔案放入 `data/` 目錄
   - 檔案名稱格式：`{testName}_{subject}_{series_no}.xlsx`
   - 例如：`IPAS_01初級_L11 人工智慧基礎概論_11409.xlsx`

2. **執行轉換**
   ```bash
   node scripts/convertExcelToJSON.js
   ```
   - 會自動：
     - 解析檔案名稱，提取 `testName`、`subject`、`series_no`
     - 轉換 Excel 為 JSON 格式
     - 生成題目檔案：`assets/data/questions/{testName}_{subject}_{series_no}.json`
     - 更新索引檔案：`assets/data/questions.json`
     - 生成題目檔案映射表：`src/services/questionFileMap.ts`

3. **更新版本號（如果需要清除舊記錄）**
   - 在 `src/services/QuestionService.ts` 中修改：
   ```typescript
   const currentVersion = '4.0.1'; // 從 4.0.0 改為 4.0.1
   ```
   - ⚠️ **注意**：版本號改變會自動清除所有用戶答題記錄和測驗進度

4. **重新啟動 App**
   - App 會偵測版本號不同，自動清除舊記錄並重新載入資料

### 清除資料

如果需要清除所有儲存的資料：

#### **React Native**
- 刪除 App 並重新安裝
- 或在 App 中實作清除功能

#### **Web**
- 清除瀏覽器的 LocalStorage：
  ```javascript
  localStorage.clear();
  ```
- 或在瀏覽器開發者工具中手動清除

## 資料備份

### 題目資料
- ✅ 已備份：`assets/data/questions.json`（在專案中）
- ✅ 來源檔案：`date/第34屆理財規劃人員專業能力.xlsx`

### 用戶答題記錄
- ⚠️ 僅存在裝置本地（AsyncStorage）
- ⚠️ 清除 App 資料會遺失
- 💡 建議：未來可加入雲端同步功能

## 檔案結構

```
quiz/
├── data/                                    # 來源資料（Excel 檔案）
│   ├── IPAS_01初級_L11 人工智慧基礎概論_11409.xlsx
│   ├── IPAS_01初級_L11 人工智慧基礎概論_11411.xlsx
│   └── ...
│
├── assets/
│   ├── data/
│   │   ├── questions.json                    # 索引檔案（測驗列表、科目列表等）
│   │   └── questions/                       # 題目檔案目錄
│   │       ├── IPAS_01_L11_11409.json
│   │       ├── IPAS_01_L11_11411.json
│   │       ├── IPAS_02_L22_11411.json
│   │       └── ...
│   └── images/                              # 圖片資源
│       └── {testName}_{subject}_{series_no}/
│           └── *.png
│
├── scripts/
│   └── convertExcelToJSON.js                # Excel 轉 JSON 轉換腳本
│
├── src/
│   └── services/
│       ├── QuestionService.ts                # 資料管理服務
│       │   ├── 載入索引檔案
│       │   ├── 按需載入題目檔案
│       │   ├── 從 metadata 補充題目資訊
│       │   └── 管理用戶答題記錄
│       └── questionFileMap.ts                # 題目檔案映射表（自動生成）
│
└── [裝置本地儲存]                            # AsyncStorage
    ├── @quiz:userAnswers                    # 答題記錄（key: 題目 id）
    ├── @quiz:chapters                       # 章節列表
    ├── @quiz:testNames                      # 測驗名稱列表
    ├── @quiz:subjects                       # 科目列表
    ├── @quiz:series                         # 期數列表
    ├── @quiz:quizProgress                   # 測驗進度
    └── @quiz:dataVersion                    # 資料版本（目前：4.0.0）
```

## 注意事項

1. **JSON 檔案位置**
   - `assets/data/questions.json` 和所有題目檔案會被打包進 App
   - 修改後需要重新建置 App 才會生效

2. **題目 ID 格式變更**
   - 舊格式（已棄用）：`L22_11411_1`
   - 新格式：`IPAS_02_L22_11411_1`
   - 格式：`{testName}_{subject}_{series_no}_{題號}`
   - ⚠️ 版本更新時會自動清除舊的答題記錄（因為 ID 格式已改變）

3. **資料結構優化**
   - 題目物件中不再重複儲存 `testName`、`subject`、`series_no`
   - 這些資訊存在於檔案的 `metadata` 中
   - 載入時會自動從 `metadata` 補充到題目物件

4. **AsyncStorage 限制**
   - 儲存大小限制約 6MB（iOS）或 10MB（Android）
   - 題目資料按需載入，不會全部存在 AsyncStorage
   - 只有用戶答題記錄和進度資訊存在 AsyncStorage

5. **資料同步**
   - 不同裝置之間的資料不會自動同步
   - 需要實作雲端同步功能才能跨裝置使用

6. **版本管理**
   - 當前資料版本：`4.0.0`
   - 版本變更會自動清除用戶答題記錄和測驗進度
   - 如需保留舊記錄，需要實作資料遷移邏輯




