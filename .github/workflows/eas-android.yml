name: Android Build (EAS)

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - app.json
      - package.json
      - package-lock.json
      - eas.json
      - src/**
      - assets/**
      - scripts/**

jobs:
  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        profile: [preview, production]
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EAS_NO_VCS_WARNING: 1
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Prepare build assets
        run: npm run prepare-build

      - name: Install EAS CLI
        run: npm install --global eas-cli

      - name: Build and wait for completion (${{ matrix.profile }})
        id: build
        env:
          PROFILE: ${{ matrix.profile }}
        run: |
          echo "Starting EAS build for profile: ${PROFILE}"
          BUILD_OUTPUT=$(npx eas-cli build --platform android --profile ${PROFILE} --non-interactive --json 2>&1)
          echo "$BUILD_OUTPUT" > build-output.json
          
          # Parse build ID from output
          BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
          if [ -z "$BUILD_ID" ]; then
            echo "Failed to get build ID"
            cat build-output.json
            exit 1
          fi
          
          echo "Build ID: $BUILD_ID"
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          
          # Wait for build to complete (poll every 30 seconds, max 40 minutes)
          echo "Waiting for build to complete..."
          MAX_ATTEMPTS=80
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            sleep 30
            ATTEMPT=$((ATTEMPT + 1))
            
            BUILD_STATUS=$(npx eas-cli build:view $BUILD_ID --json 2>/dev/null | grep -o '"status":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "unknown")
            
            echo "Attempt $ATTEMPT: Build status is $BUILD_STATUS"
            
            if [ "$BUILD_STATUS" = "finished" ]; then
              echo "Build completed successfully!"
              break
            elif [ "$BUILD_STATUS" = "errored" ] || [ "$BUILD_STATUS" = "canceled" ]; then
              echo "Build failed with status: $BUILD_STATUS"
              npx eas-cli build:view $BUILD_ID --json
              exit 1
            fi
          done
          
          if [ "$BUILD_STATUS" != "finished" ]; then
            echo "Build did not complete within timeout"
            exit 1
          fi

      - name: Download artifact (${{ matrix.profile }})
        env:
          PROFILE: ${{ matrix.profile }}
          BUILD_ID: ${{ steps.build.outputs.build_id }}
        run: |
          set -e
          mkdir -p artifacts/${PROFILE}
          
          # Get build details
          BUILD_JSON=$(npx eas-cli build:view $BUILD_ID --json)
          echo "$BUILD_JSON" > build-details.json
          
          # Extract download URL
          URL=$(echo "$BUILD_JSON" | grep -o '"buildUrl":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
          if [ -z "$URL" ]; then
            URL=$(echo "$BUILD_JSON" | grep -o '"applicationArchiveUrl":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
          fi
          
          if [ -z "$URL" ]; then
            echo "Failed to get download URL"
            cat build-details.json
            exit 1
          fi
          
          echo "Download URL: $URL"
          
          # Determine file extension
          if echo "$URL" | grep -q "\.apk"; then
            EXT="apk"
          else
            EXT="aab"
          fi
          
          OUT_FILE="artifacts/${PROFILE}/app.${EXT}"
          curl -L "$URL" -o "$OUT_FILE"
          echo "Downloaded to: $OUT_FILE"

      - name: Upload artifact (${{ matrix.profile }})
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.profile }}
          path: artifacts/${{ matrix.profile }}

